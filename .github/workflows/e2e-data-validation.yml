name: ðŸ” E2E Data Validation - Excel â†’ Firestore â†’ UI

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths:
      - 'tests/e2e/**'
      - 'tests/integration/**'
      - 'services/**'
      - 'src/**'
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 8 * * *'  # Diario a las 8 AM UTC

env:
  FIRESTORE_EMULATOR_HOST: localhost:8080
  NODE_VERSION: '20.x'

jobs:
  e2e-validation:
    name: ðŸŽ¯ E2E Complete Validation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ============================================================================
      # SETUP
      # ============================================================================
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci
          npm install -g firebase-tools
          npx playwright install --with-deps chromium

      # ============================================================================
      # START EMULATOR
      # ============================================================================
      - name: ðŸ”¥ Start Firebase Emulator
        run: |
          firebase emulators:start --only firestore --project demo-test &
          sleep 20
          curl -s http://localhost:8080 && echo "âœ… Emulator ready"

      # ============================================================================
      # INTEGRATION TESTS
      # ============================================================================
      - name: ðŸ§ª Run Integration Tests
        id: integration
        run: |
          echo "ðŸ§ª Ejecutando tests de integraciÃ³n con Firestore..."
          npm test -- tests/integration/ 2>&1 | tee integration-results.log
        continue-on-error: true

      - name: ðŸ“Š Integration Results
        run: |
          if [[ "${{ steps.integration.outcome }}" == "success" ]]; then
            echo "âœ… Integration tests passed"
            echo "INTEGRATION_PASSED=true" >> $GITHUB_ENV
          else
            echo "âŒ Integration tests failed"
            echo "INTEGRATION_PASSED=false" >> $GITHUB_ENV
          fi

      # ============================================================================
      # E2E TESTS
      # ============================================================================
      - name: ðŸŽ­ Run E2E Tests (Excel â†’ Firestore â†’ UI)
        id: e2e
        run: |
          echo "ðŸŽ­ Ejecutando tests E2E completos..."
          npm run test:e2e -- tests/e2e/ 2>&1 | tee e2e-results.log
        continue-on-error: true

      - name: ðŸ“Š E2E Results
        run: |
          if [[ "${{ steps.e2e.outcome }}" == "success" ]]; then
            echo "âœ… E2E tests passed"
            echo "E2E_PASSED=true" >> $GITHUB_ENV
          else
            echo "âŒ E2E tests failed"
            echo "E2E_PASSED=false" >> $GITHUB_ENV
          fi

      # ============================================================================
      # VALIDATION REPORTS
      # ============================================================================
      - name: ðŸ“‹ Generate Validation Report
        if: always()
        run: |
          cat > validation-report.md << 'EOF'
          # ðŸ” Reporte de ValidaciÃ³n E2E
          
          ## ðŸ“Š Resultados Generales
          
          - **Integration Tests**: ${{ env.INTEGRATION_PASSED == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
          - **E2E Tests**: ${{ env.E2E_PASSED == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
          - **Workflow Run**: #${{ github.run_number }}
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          
          ## ðŸ”¥ Tests de IntegraciÃ³n (Firestore Real)
          
          ### Tests Ejecutados:
          - âœ… CRUD Operations (Create, Read, Update, Delete)
          - âœ… Multiple Bancos Operations
          - âœ… Query Operations
          - âœ… RF Actual Operations
          - âœ… Error Handling
          - âœ… Performance Tests
          
          ### Resultados:
          ${{ env.INTEGRATION_PASSED == 'true' && 'âœ… Todos los tests de integraciÃ³n pasaron exitosamente' || 'âŒ Algunos tests de integraciÃ³n fallaron' }}
          
          ## ðŸŽ¯ Tests E2E (Excel â†’ Firestore â†’ UI)
          
          ### Flujo Validado:
          1. ðŸ“Š **Excel Data** â†’ Firestore
          2. ðŸ”¥ **Firestore** â†’ Application Logic
          3. ðŸŽ¨ **Application** â†’ UI Components
          
          ### Tests Ejecutados:
          - âœ… Data Flow Validation
          - âœ… KPIs Calculation
          - âœ… Table Data Structure
          - âœ… Data Consistency
          - âœ… Summary & Aggregations
          
          ### Resultados:
          ${{ env.E2E_PASSED == 'true' && 'âœ… ValidaciÃ³n E2E completa exitosa' || 'âŒ ValidaciÃ³n E2E requiere revisiÃ³n' }}
          
          ## ðŸ“ˆ MÃ©tricas de Calidad
          
          - **Cobertura de Datos**: Excel â†’ Firestore â†’ UI
          - **Integridad de Datos**: ${{ env.INTEGRATION_PASSED == 'true' && env.E2E_PASSED == 'true' && 'âœ… Verificada' || 'âš ï¸ Requiere revisiÃ³n' }}
          - **Consistencia**: ${{ env.INTEGRATION_PASSED == 'true' && 'âœ… Validada' || 'âš ï¸ Con issues' }}
          
          ## ðŸ”— Enlaces
          
          - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Commit Details](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ---
          ðŸ¤– Auto-generado por E2E Validation System
          EOF
          
          cat validation-report.md

      # ============================================================================
      # UPLOAD ARTIFACTS
      # ============================================================================
      - name: ðŸ“¦ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-validation-results
          path: |
            integration-results.log
            e2e-results.log
            validation-report.md
            playwright-report/
          retention-days: 30

      - name: ðŸ“¦ Upload Screenshots (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: test-results/
          retention-days: 7
        continue-on-error: true

      # ============================================================================
      # COMMENT ON PR
      # ============================================================================
      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('validation-report.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });

      # ============================================================================
      # CREATE ISSUE IF FAILED
      # ============================================================================
      - name: âŒ Create Issue on Failure
        if: env.INTEGRATION_PASSED != 'true' || env.E2E_PASSED != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let integrationLog = '';
            let e2eLog = '';
            
            try {
              integrationLog = fs.readFileSync('integration-results.log', 'utf8').slice(-3000);
            } catch (e) {
              integrationLog = 'Log no disponible';
            }
            
            try {
              e2eLog = fs.readFileSync('e2e-results.log', 'utf8').slice(-3000);
            } catch (e) {
              e2eLog = 'Log no disponible';
            }
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ E2E Validation Failed - Excel â†’ Firestore â†’ UI',
              labels: ['bug', 'e2e', 'validation-failed'],
              body: `## ðŸš¨ Fallo en ValidaciÃ³n E2E
            
            La validaciÃ³n completa del flujo de datos fallÃ³.
            
            ### ðŸ“Š Estado de Tests
            
            - **Integration Tests**: ${{ env.INTEGRATION_PASSED == 'true' ? 'âœ… PASSED' : 'âŒ FAILED' }}
            - **E2E Tests**: ${{ env.E2E_PASSED == 'true' ? 'âœ… PASSED' : 'âŒ FAILED' }}
            
            ### ðŸ” Logs de IntegraciÃ³n
            
            \`\`\`
            ${integrationLog}
            \`\`\`
            
            ### ðŸŽ­ Logs E2E
            
            \`\`\`
            ${e2eLog}
            \`\`\`
            
            ### ðŸ”— Enlaces
            
            - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Ver Artefactos](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)
            
            ---
            ðŸ¤– Auto-generado por E2E Validation System`
            });
            
            console.log('Issue creado:', issue.data.html_url);

      # ============================================================================
      # CLEANUP
      # ============================================================================
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          pkill -f firebase || true
          echo "âœ… Cleanup completado"

      # ============================================================================
      # SUMMARY
      # ============================================================================
      - name: ðŸ“Š Job Summary
        if: always()
        run: |
          cat validation-report.md >> $GITHUB_STEP_SUMMARY
