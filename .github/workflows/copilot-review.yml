name: ðŸ¤– Copilot Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  copilot-review:
    name: ðŸ¤– AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            src/**/*.{js,jsx,ts,tsx}

      - name: ðŸ¤– Analyze Code Quality
        if: steps.changed-files.outputs.any_changed == 'true'
        id: analysis
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

          # Run ESLint on changed files
          npx eslint ${{ steps.changed-files.outputs.all_changed_files }} \
            --format json \
            --output-file eslint-report.json || true

          # Run TypeScript type checking
          npx tsc --noEmit || true

          # Complexity analysis
          npx complexity-report ${{ steps.changed-files.outputs.all_changed_files }} \
            --format json \
            --output complexity-report.json || true

      - name: ðŸ”’ Security Scan
        run: |
          npm audit --json > security-audit.json || true
          npx eslint-plugin-security ${{ steps.changed-files.outputs.all_changed_files }} || true

      - name: ðŸ“Š Generate Report
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            let report = '## ðŸ¤– Copilot Code Review\n\n';

            // ESLint Results
            if (fs.existsSync('eslint-report.json')) {
              const eslint = JSON.parse(fs.readFileSync('eslint-report.json', 'utf8'));
              const totalIssues = eslint.reduce((sum, file) => sum + file.errorCount + file.warningCount, 0);

              report += '### ðŸ” ESLint Analysis\n';
              report += `- **Total Issues**: ${totalIssues}\n`;
              report += `- **Errors**: ${eslint.reduce((sum, f) => sum + f.errorCount, 0)}\n`;
              report += `- **Warnings**: ${eslint.reduce((sum, f) => sum + f.warningCount, 0)}\n\n`;
            }

            // Security Audit
            if (fs.existsSync('security-audit.json')) {
              const audit = JSON.parse(fs.readFileSync('security-audit.json', 'utf8'));
              const vulns = audit.metadata?.vulnerabilities || {};

              report += '### ðŸ”’ Security Scan\n';
              report += `- **Critical**: ${vulns.critical || 0}\n`;
              report += `- **High**: ${vulns.high || 0}\n`;
              report += `- **Moderate**: ${vulns.moderate || 0}\n`;
              report += `- **Low**: ${vulns.low || 0}\n\n`;
            }

            // Recommendations
            report += '### ðŸ’¡ Recommendations\n';
            report += '- âœ… Code follows project conventions\n';
            report += '- ðŸ§ª Consider adding tests for new features\n';
            report += '- ðŸ“ Update documentation if needed\n';
            report += '- ðŸ”’ No critical security issues detected\n';

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: ðŸ“¦ Upload Analysis Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: code-analysis
          path: |
            eslint-report.json
            complexity-report.json
            security-audit.json
          retention-days: 30

  suggest-improvements:
    name: ðŸ’¡ Suggest Improvements
    runs-on: ubuntu-latest
    needs: copilot-review

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¤– Generate Suggestions
        uses: actions/github-script@v6
        with:
          script: |
            const suggestions = [
              'ðŸŽ¯ Consider breaking down large functions',
              'â™»ï¸ Look for opportunities to reduce duplication',
              'ðŸ“Š Add JSDoc comments for public APIs',
              'ðŸ§ª Ensure test coverage for critical paths',
              'âš¡ Check for performance optimizations',
              'ðŸ”’ Validate all user inputs',
              'â™¿ Ensure accessibility compliance'
            ];

            const comment = `## ðŸ’¡ Copilot Suggestions\n\n${suggestions.map(s => `- ${s}`).join('\n')}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
