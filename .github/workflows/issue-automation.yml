name: ğŸ¯ Issue & Project Automation

on:
  issues:
    types: [opened, labeled, edited, closed]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, labeled, closed]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  # ============================================================================
  # AUTO LABEL
  # ============================================================================
  auto-label:
    name: ğŸ·ï¸ Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: ğŸ¤– Analyze Issue Content
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const content = title + ' ' + body;

            let labels = [];

            // Bug detection
            if (content.match(/\b(bug|error|crash|broken|fix|issue)\b/)) {
              labels.push('bug');
            }

            // Feature detection
            if (content.match(/\b(feature|enhancement|improve|add|new)\b/)) {
              labels.push('enhancement');
            }

            // Documentation
            if (content.match(/\b(doc|documentation|readme|guide)\b/)) {
              labels.push('documentation');
            }

            // Security
            if (content.match(/\b(security|vulnerability|exploit|xss|sql)\b/)) {
              labels.push('security');
              labels.push('high-priority');
            }

            // Performance
            if (content.match(/\b(performance|slow|speed|optimize)\b/)) {
              labels.push('performance');
            }

            // Testing
            if (content.match(/\b(test|testing|spec|e2e)\b/)) {
              labels.push('testing');
            }

            // UI/UX
            if (content.match(/\b(ui|ux|design|style|css)\b/)) {
              labels.push('ui-ux');
            }

            // Priority detection
            if (content.match(/\b(urgent|critical|asap|blocker)\b/)) {
              labels.push('urgent');
            }

            // Add labels
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

      - name: ğŸ’¬ Welcome Message
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ğŸ‘‹ Thank you for opening this issue!

              Your issue has been automatically labeled. A team member will review it soon.

              **Next Steps:**
              - âœ… Make sure you've provided all necessary information
              - ğŸ“¸ Add screenshots if relevant
              - ğŸ”„ Keep an eye on this issue for updates

              ---
              ğŸ’¡ **Tip**: Add the \`copilot-agent\` label to have AI assist with implementation!`
            });

  # ============================================================================
  # COPILOT AGENT ASSIGNMENT
  # ============================================================================
  copilot-agent:
    name: ğŸ¤– Copilot Agent Assignment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      github.event.label.name == 'copilot-agent'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¤– Assign to Copilot
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ğŸ¤– **Copilot Agent Assigned!**

              I'll analyze this issue and create a solution. Here's what I'll do:

              1. ğŸ“– Analyze the requirements
              2. ğŸ’» Generate implementation code
              3. ğŸ§ª Add tests
              4. ğŸ“ Update documentation
              5. ğŸ”„ Create a Pull Request

              â±ï¸ **Estimated time**: 5-10 minutes

              I'll notify you when the PR is ready for review!`
            });

            // Add "in-progress" label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['in-progress']
            });

  # ============================================================================
  # STALE ISSUES
  # ============================================================================
  stale:
    name: ğŸ—‘ï¸ Mark Stale Issues
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ—‘ï¸ Stale Action
        uses: actions/stale@v8
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: |
            ğŸ‘‹ This issue has been automatically marked as stale because it has not had recent activity.

            It will be closed if no further activity occurs within 7 days.

            If this issue is still relevant, please comment to keep it open.
          stale-pr-message: |
            ğŸ‘‹ This pull request has been automatically marked as stale because it has not had recent activity.

            It will be closed if no further activity occurs within 7 days.
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          days-before-stale: 60
          days-before-close: 7
          exempt-issue-labels: 'security,urgent,high-priority,in-progress'

  # ============================================================================
  # AUTO CLOSE COMPLETED
  # ============================================================================
  auto-close:
    name: âœ… Auto Close on PR Merge
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true

    steps:
      - name: ğŸ” Find Linked Issues
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;

            // Extract issue numbers from PR body
            const issueNumbers = (pr.body || '').match(/(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi);

            if (issueNumbers) {
              for (const match of issueNumbers) {
                const issueNumber = parseInt(match.match(/\d+/)[0]);

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `âœ… Fixed in PR #${pr.number}\n\nğŸ‰ This issue has been resolved and merged into \`${pr.base.ref}\``
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });
              }
            }

  # ============================================================================
  # ISSUE METRICS
  # ============================================================================
  metrics:
    name: ğŸ“Š Issue Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'closed'

    steps:
      - name: ğŸ“Š Calculate Response Time
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const created = new Date(issue.created_at);
            const closed = new Date(issue.closed_at);
            const responseTime = Math.round((closed - created) / (1000 * 60 * 60)); // hours

            console.log(`Issue #${issue.number} resolved in ${responseTime} hours`);

            // Puedes enviar esto a un sistema de analytics
