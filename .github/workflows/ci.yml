name: ğŸ§ª CI - Testing & Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================================================
  # LINTING & FORMATTING
  # ============================================================================
  lint:
    name: ğŸ” Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” ESLint
        run: npm run lint

      - name: ğŸ’… Prettier
        run: npx prettier --check "src/**/*.{js,jsx,ts,tsx,json,css,md}"

      - name: ğŸ“Š Type Check
        run: npx tsc --noEmit

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 21]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run Vitest
        run: npm run test

      - name: ğŸ“Š Coverage Report
        run: npm run test:coverage

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unit
          name: unit-tests-${{ matrix.node-version }}

  # ============================================================================
  # E2E TESTS
  # ============================================================================
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ğŸ—ï¸ Build
        run: npm run build

      - name: ğŸš€ Start Preview Server
        run: npm run preview &
        env:
          CI: true

      - name: â³ Wait for server
        run: npx wait-on http://localhost:4173 --timeout 60000

      - name: ğŸ­ Run Playwright tests
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          CI: true

      - name: ğŸ“¦ Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ğŸ” Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'chronos-system'
          path: '.'
          format: 'HTML'

      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: reports/

  # ============================================================================
  # BUILD TEST
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“Š Bundle Size Check
        run: |
          npx bundlesize
        continue-on-error: true

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: dist/
          retention-days: 7

  # ============================================================================
  # PERFORMANCE CHECK
  # ============================================================================
  performance:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: dist
          path: dist/

      - name: ğŸ¯ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: ğŸš€ Serve build
        run: |
          npm install -g serve
          serve -s dist -l 4173 &
          sleep 5

      - name: âš¡ Run Lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:4173
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ============================================================================
  # STATUS CHECK
  # ============================================================================
  ci-status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests, security, build, performance]
    if: always()

    steps:
      - name: ğŸ“Š Check CI Results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.e2e-tests.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ CI checks failed"
            exit 1
          fi
          echo "âœ… All CI checks passed"
